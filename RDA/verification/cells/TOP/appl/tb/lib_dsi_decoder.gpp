
**------------------------------------------------
** Transmit Decoder of DSI3 Bus Communication
**------------------------------------------------

define dsi_transmit_decoder(__ch__=0)

  `var(name=dsi__ch___transmit_decoder_vhigh)
  `var(name=dsi__ch___transmit_decoder_v)
 
  `var(name=dsi__ch___transmit_decoder_word     type=reg[31:0])
  `var(name=dsi__ch___transmit_decoder_word_cnt type=integer)
  
  `var(name=dsi__ch___transmit_decoder_bits     type=reg[3:0])
  `var(name=dsi__ch___transmit_decoder_bits_cnt type=integer)
  
  `var(name=dsi__ch___transmit_decoder_chip     type=reg[1:0])
 
  `always(name=DSI Transmit Decoder DSI__ch__)
  
    `cross_d(name=cross_dsi__ch___transmit_decoder1 s=xtbctrl.crm_dsi__ch___decoder_pending dir=1 t=1`k)
    `if models[0]
      `cross_d(name=cross_dsi__ch___transmit_decoder2 s=xdut.xdigi.O_DSI_TX_DATA[5*__ch__]        t=1`k)
    `endif
    `if "$SPSCR_MACROTYPE" eq "SV"
    
      dsi__ch___transmit_decoder_bits_cnt = 3;
      dsi__ch___transmit_decoder_vhigh = $snps_get_volt(snps_sptop.dsi__ch___pcb);
      
      #(master_period);

      for (dsi__ch___transmit_decoder_word_cnt=63; dsi__ch___transmit_decoder_word_cnt>=0; dsi__ch___transmit_decoder_word_cnt=dsi__ch___transmit_decoder_word_cnt-1) begin
      
        dsi__ch___transmit_decoder_v = dsi__ch___transmit_decoder_vhigh - $snps_get_volt(snps_sptop.dsi__ch___pcb);
        if (dsi__ch___transmit_decoder_v < 1.0) begin dsi__ch___transmit_decoder_bits[dsi__ch___transmit_decoder_bits_cnt] = 1; end
        else                                 begin dsi__ch___transmit_decoder_bits[dsi__ch___transmit_decoder_bits_cnt] = 0; end
	
        dsi__ch___transmit_decoder_bits_cnt = dsi__ch___transmit_decoder_bits_cnt - 1;
        
	if (dsi__ch___transmit_decoder_bits_cnt < 0) begin
	
	  if (dsi__ch___transmit_decoder_bits == 'b0101) dsi__ch___transmit_decoder_chip = 0;
	  if (dsi__ch___transmit_decoder_bits == 'b0110) dsi__ch___transmit_decoder_chip = 1;
	  if (dsi__ch___transmit_decoder_bits == 'b1001) dsi__ch___transmit_decoder_chip = 2;
	  if (dsi__ch___transmit_decoder_bits == 'b1010) dsi__ch___transmit_decoder_chip = 3;
	  
	  if (dsi__ch___transmit_decoder_word_cnt == 60) dsi__ch___transmit_decoder_word[31:30] = dsi__ch___transmit_decoder_chip;
	  if (dsi__ch___transmit_decoder_word_cnt == 56) dsi__ch___transmit_decoder_word[29:28] = dsi__ch___transmit_decoder_chip;
	  if (dsi__ch___transmit_decoder_word_cnt == 52) dsi__ch___transmit_decoder_word[27:26] = dsi__ch___transmit_decoder_chip;
	  if (dsi__ch___transmit_decoder_word_cnt == 48) dsi__ch___transmit_decoder_word[25:24] = dsi__ch___transmit_decoder_chip;
	  if (dsi__ch___transmit_decoder_word_cnt == 44) dsi__ch___transmit_decoder_word[23:22] = dsi__ch___transmit_decoder_chip;
	  if (dsi__ch___transmit_decoder_word_cnt == 40) dsi__ch___transmit_decoder_word[21:20] = dsi__ch___transmit_decoder_chip;
	  if (dsi__ch___transmit_decoder_word_cnt == 36) dsi__ch___transmit_decoder_word[19:18] = dsi__ch___transmit_decoder_chip;
	  if (dsi__ch___transmit_decoder_word_cnt == 32) dsi__ch___transmit_decoder_word[17:16] = dsi__ch___transmit_decoder_chip;
	  if (dsi__ch___transmit_decoder_word_cnt == 28) dsi__ch___transmit_decoder_word[15:14] = dsi__ch___transmit_decoder_chip;
	  if (dsi__ch___transmit_decoder_word_cnt == 24) dsi__ch___transmit_decoder_word[13:12] = dsi__ch___transmit_decoder_chip;
	  if (dsi__ch___transmit_decoder_word_cnt == 20) dsi__ch___transmit_decoder_word[11:10] = dsi__ch___transmit_decoder_chip;
	  if (dsi__ch___transmit_decoder_word_cnt == 16) dsi__ch___transmit_decoder_word[9:8]   = dsi__ch___transmit_decoder_chip;
	  if (dsi__ch___transmit_decoder_word_cnt == 12) dsi__ch___transmit_decoder_word[7:6]   = dsi__ch___transmit_decoder_chip;
	  if (dsi__ch___transmit_decoder_word_cnt == 8)  dsi__ch___transmit_decoder_word[5:4]   = dsi__ch___transmit_decoder_chip;
	  if (dsi__ch___transmit_decoder_word_cnt == 4)  dsi__ch___transmit_decoder_word[3:2]   = dsi__ch___transmit_decoder_chip;
	  if (dsi__ch___transmit_decoder_word_cnt == 0)  dsi__ch___transmit_decoder_word[1:0]   = dsi__ch___transmit_decoder_chip;
					
	  dsi__ch___transmit_decoder_bits_cnt = 3;
	  
        end
      
        #(0.5*master_period);
      
      end
	
    `endif

    `calc( name  = crm_dsi__ch___transmit_decoder
           expr  = dsi__ch___transmit_decoder_word
	   print = 0)
	   
    `set_var(name=crm_dsi__ch___decoder_pending val=0)
    
  `endalways
  
enddefine

**------------------------------------------------
** Main
**------------------------------------------------

`dsi_transmit_decoder(ch=0)
`dsi_transmit_decoder(ch=1)

**------------------------------------------------
**------------------------------------------------
