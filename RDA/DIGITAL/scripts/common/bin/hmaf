#!/bin/csh -f

#############################################
#                                           #
#  THIS SCRIPT EXECUTES A HIERARCHICAL MAF  #
#                                           #
#  - searches for makefile.local's          #
#  - executes "make files" on each of them  #
#    including "make links", if a makefile  #
#    with "links" target is present in the  #
#    current directory                      #
#                                           #
#############################################

mkdir -p ${HOME}/.submit

set file=`mktemp -p ${HOME}/.submit/`

collect_makefile_local_targets.py > ${file}

if ( ! -f makefile ) then
  sed -i -e "s/.*MAKE.* links//" ${file}
else
  if ( "`grep '^links:' makefile`" == "" ) then
    sed -i -e "s/.*MAKE.* links//" ${file}
  endif
endif

make -B -C . -f ${file} files

rm -f ${file}

